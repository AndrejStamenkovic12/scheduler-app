{% extends "base.html" %}

{% block title %}Find Near You - Appointment Scheduler{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="card glass-effect fade-in-up mb-4">
        <div class="card-body p-4 text-center">
            <i class="fas fa-map-marker-alt fa-4x mb-3" style="background: var(--secondary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
            <h1 class="gradient-text mb-3" data-translate="find-near-you">Find Near You</h1>
            <p class="text-muted mb-0" data-translate="find-near-you-description">Discover providers in Serbia</p>
        </div>
    </div>

    <!-- Interactive Map -->
    <div class="card glass-effect fade-in-up">
        <div class="card-header glass-effect">
            <h5 class="mb-0 gradient-text">
                <i class="fas fa-map me-2"></i><span data-translate="serbia-map">Serbia Map</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div id="map" style="height: 600px; width: 100%;"></div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Initialize the map
document.addEventListener('DOMContentLoaded', function() {
    // Create map centered on Serbia with zoom restrictions
    const map = L.map('map', {
        center: [44.0165, 21.0059],  // Center on Serbia
        zoom: 7,  // Start at zoom level 7 to show Serbia
        minZoom: 6,  // Prevent zooming out too far
        maxZoom: 18,
        maxBounds: [[40.5, 18.5], [47.5, 23.5]],  // Restrict to Serbia and surrounding area
        maxBoundsViscosity: 1.0  // Strict boundary enforcement
    });

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        minZoom: 6,
        maxZoom: 19,
        noWrap: true  // Prevent tile repetition
    }).addTo(map);


    // Add zoom controls
    L.control.zoom({
        position: 'topright'
    }).addTo(map);

    // Add scale control
    L.control.scale({
        position: 'bottomright'
    }).addTo(map);

    // Add custom controls
    const customControl = L.control({ position: 'topleft' });
    customControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'custom-control');
        div.innerHTML = `
            <div class="btn-group-vertical" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="map.setView([44.0165, 21.0059], 7)" title="Serbia View">
                    <i class="fas fa-map"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()" title="My Location">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="showAllProviders()" title="Show All Providers">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        `;
        return div;
    };
    customControl.addTo(map);

    // Add legend
    const legendControl = L.control({ position: 'bottomleft' });
    legendControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'map-legend');
        div.innerHTML = `
            <div class="legend-content">
                <h6 class="mb-2"><i class="fas fa-info-circle me-1"></i>Service Types</h6>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #e91e63;"></span>
                        <span class="legend-text">Hair Salon</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #9c27b0;"></span>
                        <span class="legend-text">Nail Salon</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #4caf50;"></span>
                        <span class="legend-text">Massage</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #00bcd4;"></span>
                        <span class="legend-text">Spa</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #ff9800;"></span>
                        <span class="legend-text">Training</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #2196f3;"></span>
                        <span class="legend-text">Medical</span>
                    </div>
                </div>
            </div>
        `;
        return div;
    };
    legendControl.addTo(map);

    // Store map reference globally
    window.map = map;
    
    // Load and display provider pins
    loadProviderPins();
});

// Load provider pins from API
async function loadProviderPins() {
    try {
        const response = await fetch('/api/providers');
        const providers = await response.json();
        
        // Geocode each provider address and add pins
        for (const provider of providers) {
            await geocodeAndAddPin(provider);
        }
    } catch (error) {
        console.error('Error loading providers:', error);
    }
}

// Geocode address and add pin to map
async function geocodeAndAddPin(provider) {
    try {
        // Use OpenStreetMap Nominatim API for geocoding
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(provider.address)}&limit=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            
            // Create custom icon based on service category
            const icon = createProviderIcon(provider.service_category);
            
            // Add marker to map
            const marker = L.marker([lat, lng], { icon: icon }).addTo(window.map);
            
            // Create popup content
            const popupContent = createProviderPopup(provider);
            marker.bindPopup(popupContent);
        }
    } catch (error) {
        console.error(`Error geocoding ${provider.business_name}:`, error);
    }
}

// Create custom icon for provider based on service category
function createProviderIcon(serviceCategory) {
    const iconColors = {
        'hair_salon': '#e91e63',
        'nail_salon': '#9c27b0',
        'massage_therapy': '#4caf50',
        'spa_treatment': '#00bcd4',
        'personal_training': '#ff9800',
        'yoga_classes': '#8bc34a',
        'pilates': '#cddc39',
        'dermatology': '#2196f3',
        'physical_therapy': '#3f51b5',
        'nutrition_counseling': '#795548',
        'makeup_artist': '#f44336',
        'photography': '#607d8b',
        'life_coaching': '#9e9e9e',
        'eyebrow_eyelash': '#ff5722',
        'aromatherapy': '#673ab7'
    };
    
    const color = iconColors[serviceCategory] || '#666666';
    
    return L.divIcon({
        className: 'custom-provider-icon',
        html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
}

// Create popup content for provider
function createProviderPopup(provider) {
    const serviceIcons = {
        'hair_salon': 'fas fa-cut',
        'nail_salon': 'fas fa-hand-sparkles',
        'massage_therapy': 'fas fa-spa',
        'spa_treatment': 'fas fa-leaf',
        'personal_training': 'fas fa-dumbbell',
        'yoga_classes': 'fas fa-om',
        'pilates': 'fas fa-running',
        'dermatology': 'fas fa-user-md',
        'physical_therapy': 'fas fa-heartbeat',
        'nutrition_counseling': 'fas fa-apple-alt',
        'makeup_artist': 'fas fa-palette',
        'photography': 'fas fa-camera',
        'life_coaching': 'fas fa-lightbulb',
        'eyebrow_eyelash': 'fas fa-eye',
        'aromatherapy': 'fas fa-seedling'
    };
    
    const serviceNames = {
        'hair_salon': 'Hair Salon',
        'nail_salon': 'Nail Salon',
        'massage_therapy': 'Massage Therapy',
        'spa_treatment': 'Spa Treatment',
        'personal_training': 'Personal Training',
        'yoga_classes': 'Yoga Classes',
        'pilates': 'Pilates',
        'dermatology': 'Dermatology',
        'physical_therapy': 'Physical Therapy',
        'nutrition_counseling': 'Nutrition Consulting',
        'makeup_artist': 'Makeup Artist',
        'photography': 'Photography',
        'life_coaching': 'Life Coaching',
        'eyebrow_eyelash': 'Eyebrow & Eyelash',
        'aromatherapy': 'Aromatherapy'
    };
    
    const icon = serviceIcons[provider.service_category] || 'fas fa-store';
    const serviceName = serviceNames[provider.service_category] || 'Service Provider';
    
    // Use services_offered if available, otherwise use the service category name
    const servicesText = provider.services_offered && provider.services_offered.trim() !== '' 
        ? provider.services_offered 
        : serviceName;
    
    return `
        <div class="map-popup">
            <div class="d-flex align-items-center mb-2">
                <i class="${icon} me-2 text-primary"></i>
                <h6 class="mb-0">${provider.business_name}</h6>
            </div>
            <p class="text-muted small mb-2">${provider.business_description || serviceName + ' services'}</p>
            <div class="mb-2">
                <strong>Services:</strong><br>
                <span class="small">${servicesText}</span>
            </div>
            <div class="mb-2">
                <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                <span class="small">${provider.address}</span>
            </div>
            ${provider.phone ? `
            <div class="mb-2">
                <i class="fas fa-phone me-1 text-success"></i>
                <span class="small">${provider.phone}</span>
            </div>
            ` : ''}
            <div class="text-center">
                <a href="/providers/${provider.service_category.replace('_', '-')}" class="btn btn-primary btn-sm">
                    <i class="fas fa-calendar-plus me-1"></i>Book Now
                </a>
            </div>
        </div>
    `;
}

// Get current location
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Center map on user location
                window.map.setView([lat, lng], 10);
                
                // Add user location marker
                const userMarker = L.marker([lat, lng]).addTo(window.map);
                userMarker.bindPopup(`
                    <div class="map-popup">
                        <h6 class="mb-2"><i class="fas fa-user me-1"></i>Your Location</h6>
                        <p class="text-muted mb-0">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</p>
                    </div>
                `).openPopup();
            },
            function(error) {
                alert('Unable to get your current location. Please try again.');
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

// Show all providers
function showAllProviders() {
    window.map.setView([44.0165, 21.0059], 7);
}

</script>

<style>
/* Map styling */
#map {
    border-radius: 0 0 0.375rem 0.375rem;
}

/* Custom control styling */
.custom-control {
    background: white;
    border-radius: 0.375rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 0.5rem;
}

.custom-control .btn-group-vertical .btn {
    margin-bottom: 0.25rem;
}

.custom-control .btn-group-vertical .btn:last-child {
    margin-bottom: 0;
}

/* Map legend styling */
.map-legend {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    padding: 0.75rem;
    font-size: 0.875rem;
    min-width: 150px;
}

.legend-content h6 {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.legend-items {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    flex-shrink: 0;
}

.legend-text {
    font-size: 0.75rem;
    color: #666;
    font-weight: 500;
}

/* Map popup styling */
.map-popup {
    min-width: 250px;
    max-width: 300px;
}

.map-popup h6 {
    color: var(--primary-color);
    font-weight: 600;
}

.map-popup .btn {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

/* Leaflet popup customization */
.leaflet-popup-content-wrapper {
    border-radius: 0.75rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.1);
}

.leaflet-popup-content {
    margin: 0.75rem;
    line-height: 1.4;
}

.leaflet-popup-tip {
    background: white;
    border: 1px solid rgba(0,0,0,0.1);
}

/* Custom provider icon styling */
.custom-provider-icon {
    background: transparent !important;
    border: none !important;
}

.custom-provider-icon div {
    transition: all 0.3s ease;
}

.custom-provider-icon:hover div {
    transform: scale(1.2);
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}

/* Provider pin animations */
@keyframes pulse-pin {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.custom-provider-icon div {
    animation: pulse-pin 2s infinite;
}

.custom-provider-icon:hover div {
    animation: none;
}

/* Responsive map */
@media (max-width: 768px) {
    #map {
        height: 400px;
    }
}
</style>
{% endblock %}
